<!-- Google Analytics 4 -->
<script async src="https://www.googletagmanager.com/gtag/js?id={{ site.google_analytics_id }}"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}

  // Check for consent before initializing
  if (localStorage.getItem('cookieConsent') === 'accepted') {
    gtag('js', new Date());
    gtag('config', '{{ site.google_analytics_id }}', {
      'anonymize_ip': true,
      'cookie_flags': 'SameSite=None;Secure'
    });
  } else {
    // Initialize in consent mode
    gtag('consent', 'default', {
      'analytics_storage': 'denied',
      'ad_storage': 'denied'
    });
    gtag('js', new Date());
    gtag('config', '{{ site.google_analytics_id }}');
  }

  // Custom event tracking functions
  window.trackEvent = function(eventName, eventParams) {
    gtag('event', eventName, eventParams);
  };

  // Conversion tracking
  window.trackConversion = function(conversionId, value, currency) {
    gtag('event', 'conversion', {
      'send_to': conversionId,
      'value': value || 0,
      'currency': currency || 'USD'
    });
  };
</script>
