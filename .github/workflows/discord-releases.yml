name: Discord Release Notifications

on:
  release:
    types: [published, created, edited, deleted, prereleased, released]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.RELEASE_WEBHOOK }}
        run: |
          # Extract release info
          RELEASE_NAME="${{ github.event.release.name }}"
          RELEASE_TAG="${{ github.event.release.tag_name }}"
          RELEASE_URL="${{ github.event.release.html_url }}"
          AUTHOR="${{ github.event.release.author.login }}"
          ACTION="${{ github.event.action }}"
          IS_PRERELEASE="${{ github.event.release.prerelease }}"
          RELEASE_BODY="${{ github.event.release.body }}"

          # Truncate body to 1000 chars for Discord
          RELEASE_BODY=$(echo "$RELEASE_BODY" | head -c 1000)
          if [ ${#RELEASE_BODY} -ge 1000 ]; then
            RELEASE_BODY="${RELEASE_BODY}..."
          fi

          # Determine event type and color
          case "$ACTION" in
            "published"|"released")
              if [ "$IS_PRERELEASE" = "true" ]; then
                EMOJI="üöß"
                TITLE="Pre-release Published"
                COLOR=16776960  # Yellow
              else
                EMOJI="üöÄ"
                TITLE="Release Published"
                COLOR=3066993  # Green
              fi
              ;;
            "created")
              EMOJI="üì¶"
              TITLE="Release Created"
              COLOR=3447003  # Blue
              ;;
            "edited")
              EMOJI="‚úèÔ∏è"
              TITLE="Release Edited"
              COLOR=10181046  # Purple
              ;;
            "deleted")
              EMOJI="üóëÔ∏è"
              TITLE="Release Deleted"
              COLOR=15158332  # Red
              ;;
            "prereleased")
              EMOJI="üöß"
              TITLE="Pre-release Published"
              COLOR=16776960  # Yellow
              ;;
            *)
              EMOJI="üìå"
              TITLE="Release $ACTION"
              COLOR=3447003  # Blue
              ;;
          esac

          # Build JSON payload with escaped body
          ESCAPED_BODY=$(echo "$RELEASE_BODY" | jq -Rs .)

          PAYLOAD=$(cat <<EOF
          {
            "username": "GitHub Releases",
            "avatar_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
            "embeds": [{
              "title": "$EMOJI $TITLE: $RELEASE_TAG",
              "description": $ESCAPED_BODY,
              "url": "$RELEASE_URL",
              "color": $COLOR,
              "fields": [
                {
                  "name": "Release Name",
                  "value": "$RELEASE_NAME",
                  "inline": true
                },
                {
                  "name": "Author",
                  "value": "$AUTHOR",
                  "inline": true
                },
                {
                  "name": "Type",
                  "value": "$IS_PRERELEASE" == "true" ? "Pre-release" : "Release",
                  "inline": true
                }
              ],
              "timestamp": "${{ github.event.release.published_at }}"
            }]
          }
          EOF
          )

          # Send to Discord
          curl -H "Content-Type: application/json" \
               -d "$PAYLOAD" \
               "$DISCORD_WEBHOOK"
